#! /usr/bin/env node
const fetch = require('node-fetch');
const fs = require('fs');
const jsonToGo = require('../vendor/json-to-go/json-to-go.js');

function run() {
  if (process.argv.length !== 3) {
    console.log("parameter is wrong.")
    return
  }

  const apiUrl = process.argv[2].replace(/\/$/, '')
  fetch(apiUrl)
    .then(res => res.json())
    .then(json => {
        let res = jsonToGo(JSON.stringify(json), 'AutoGenerated');
        const url = new URL(apiUrl);
        const path = _parsePath(`${url.hostname}${url.pathname}`)
        const content = _buildContent(res.go, path.pkg)
        fs.mkdirSync(path.dir, {recursive: true})
        fs.writeFile(path.filePath, content, (err) => {
          if (err) throw err;
          console.log(`generated: ${path.filePath}`);
        });
      }
    );
}

function _parsePath(path) {
  const pathArr = path.split("/")
  const file = pathArr[pathArr.length - 1]+".go"
  const pkg = pathArr[pathArr.length - 2]
  pathArr.pop()
  const dir = pathArr.join("/")
  return {
    file,
    pkg,
    dir,
    filePath:`${dir}/${file}`
  }
}

function _buildContent(struct, packageName) {
  let content = `package ${packageName}\n\n`
  if (struct.indexOf('time.')) {
    content = `${content}import "time"\n\n`
  }
  content = `${content}${struct}`
  return content
}

run()
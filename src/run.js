const fetch = require('node-fetch');
const fs = require('fs');
const jsonToGo = require('../vendor/json-to-go.js');
const buildPath = require('./buildPath');
const {isJsonString, loadConfig, loadFile, loadJson} = require("./common");

let cliOpts

function run(urlStr, body, options) {
  let comment, url, path, cfg
  cliOpts = options

  let opts = {}
  try {
    opts = buildOpts(body, cliOpts)
  } catch (e) {
    console.error(e.message);
    return
  }

  // See: https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
  fetch(urlStr, opts)
    .then(res => {
      const apiUrl = urlStr.replace(/\/$/, '')
      url = new URL(apiUrl);
      cfg = loadConfig(url, cliOpts.config)
      path = buildPath(url, cliOpts.config, opts)

      console.log(`Status:  ${res.status} ${res.statusText}`)
      console.log(`Request: ${opts.method} ${url}`)
      if (path.path.pathFormat) console.log(`Format:  ${path.path.pathFormat}`)
      if (cfg?.["docs"] !== undefined) console.log(`Docs:    ${cfg?.["docs"].join(", ")}`)
      comment = buildComment(url, path, opts.method, res)

      return res.json()
    })
    .then(json => {
      const struct = jsonToGo(JSON.stringify(json), path.struct);
      const content = buildContent(struct.go, path, comment)
      write(json, path, content)

      if (opts?.body) {
        const paramStruct = jsonToGo(opts?.body, path.struct + "Param");
        const paramContent = buildContent(
            paramStruct.go, path, buildComment(url, path, opts.method), true
        )
        writeParam(JSON.stringify(JSON.parse(opts?.body), null, "\t"), path, paramContent)
      }
    }, () => {
      console.log()
      console.log("Response Body is empty.")
    })
    .catch((error) => {
      console.error(error);
    });
}

function write(json, path, content) {
  fs.mkdirSync(path.dir, {recursive: true})
  fs.writeFile(path.jsonFilePath, JSON.stringify(json, null, "\t"), (err) => {
    if (err) throw err;
  });
  fs.writeFile(path.goFilePath, content, (err) => {
    if (err) throw err;
  });
  console.log()
  console.log("Response Body:")
  console.log(`  - ${path.goFilePath}:1`)
  console.log(`  - ${path.jsonFilePath}:1`)
}

function writeParam(json, path, content) {
  fs.writeFile(path.paramJsonFilePath, json, (err) => {
    if (err) throw err;
  });
  fs.writeFile(path.paramGoFilePath, content, (err) => {
    if (err) throw err;
  });
  console.log()
  console.log("Request Body Parameter:")
  console.log(`  - ${path.paramGoFilePath}:1`)
  console.log(`  - ${path.paramJsonFilePath}:1`)
}

function buildOpts(body, cliOpts) {
  const opts = {}
  if (cliOpts?.method) opts.method = cliOpts?.method
  if (cliOpts?.headers) {
    if (isJsonString(cliOpts.headers)) {
      opts.headers = JSON.parse(cliOpts.headers)
    } else {
      opts.headers = loadJson(cliOpts.headers)
    }
  }
  if (body) {
    if (!cliOpts?.method) {
      opts.method = "POST"
    }
    if (isJsonString(body)) {
      opts.body = body
    } else {
      const bodyObj = loadFile(body)
      if (!isJsonString(bodyObj)) {
        throw new Error(`${body} is not json file.`);
      }
      opts.body = bodyObj
    }
  }
  if (cliOpts?.debug) {
    if (opts) {
      console.error(opts)
      console.error()
    }
  }
  if (!opts?.method) opts.method = "GET"
  return opts
}

function buildContent(go, path, comment, isParam = false) {
  let content = `// Generated Code But Editable.
// Format The Code with \`go fmt\` or something and edit it manually to use it.
//
// Generated by: api-to-go (https://github.com/nkmr-jp/api-to-go).

`
  content += `package ${path.pkg}\n\n`
  if (go.indexOf('time.') !== -1) {
    content += `import "time"\n\n`
  }
  if (isParam) {
    content += `// ${go.split(" ")[1]} is the HTTP request's body parameter.\n//`
  } else {
    content += `// ${go.split(" ")[1]} represents the response body from an HTTP request.\n//`
  }
  content += comment
  content += go
  return content
}

function buildComment(url, path, method, res = false) {
  let comment = ""
  if (res) {
    comment += `\n//\tStatus:  ${res.status} ${res.statusText}`
  }
  comment += `\n//\tRequest: ${method} ${url.href}`

  const cfg = loadConfig(url, cliOpts.config)
  if (path.path.pathFormat) {
    comment += `\n//\tFormat:  ${path.path.pathFormat}`
  }
  if (cfg?.["docs"] !== undefined) {
    comment += `\n//\tDocs:    ${cfg?.["docs"].join(", ")}`
  }
  return `${comment}\n`
}

module.exports = run;